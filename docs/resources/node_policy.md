---
# generated by https://github.com/hashicorp/terraform-plugin-docs
page_title: "devzero_node_policy Resource - devzero"
subcategory: ""
description: |-
  Manages DevZero node policies for Kubernetes cluster node provisioning and optimization using Karpenter.
---

# devzero_node_policy (Resource)

Manages DevZero node policies for Kubernetes cluster node provisioning and optimization using Karpenter.

## Example Usage

```terraform
# Minimal example - uses sensible defaults
resource "devzero_node_policy" "minimal" {
  name            = "minimal-policy"
  node_pool_name  = "default-pool"
  node_class_name = "default-class"

  # Defaults applied automatically:
  # - weight = 10 (medium priority)
  # - disruption.consolidate_after = "15m"
  # - disruption.consolidation_policy = "WhenEmptyOrUnderutilized"
  # - disruption.expire_after = "720h"
}

# AWS example with required fields only
resource "devzero_node_policy" "aws_basic" {
  name            = "aws-basic-policy"
  node_pool_name  = "production-pool"
  node_class_name = "production-class"

  aws = {
    role = "KarpenterNodeRole-production"
    # Secure IMDS v2 defaults applied automatically:
    # - metadata_options.http_endpoint = "enabled"
    # - metadata_options.http_protocol_ipv6 = "disabled"
    # - metadata_options.http_put_response_hop_limit = 2
    # - metadata_options.http_tokens = "required"
  }
}

# Comprehensive AWS example with all common options
resource "devzero_node_policy" "aws_comprehensive" {
  name            = "aws-comprehensive"
  description     = "Production-ready AWS node policy with comprehensive configuration"
  node_pool_name  = "production-general-pool"
  node_class_name = "production-general-class"
  weight          = 15

  # Instance selection - Use modern, cost-effective instances
  instance_categories = {
    match_expressions = [{
      key      = "instanceCategories"
      operator = "In"
      values   = ["c", "m", "r"] # Compute, general purpose, memory optimized
    }]
  }

  instance_generations = {
    match_expressions = [{
      key      = "instanceGenerations"
      operator = "Gt"
      values   = ["5"] # Modern instances only
    }]
  }

  # Architecture and capacity
  architectures = {
    match_expressions = [{
      key      = "architectures"
      operator = "In"
      values   = ["amd64"] # Can also use ["arm64"] for Graviton
    }]
  }

  capacity_types = {
    match_expressions = [{
      key      = "capacityTypes"
      operator = "In"
      values   = ["spot", "on-demand"] # Cost optimization with fallback
    }]
  }

  operating_systems = {
    match_expressions = [{
      key      = "operatingSystems"
      operator = "In"
      values   = ["linux"]
    }]
  }

  # Node labels and taints
  labels = {
    "workload-type" = "general"
    "managed-by"    = "karpenter"
  }

  taints = [
    {
      key    = "workload-type"
      value  = "batch"
      effect = "NoSchedule"
    }
  ]

  # Disruption policy for cost optimization
  disruption = {
    consolidate_after       = "15m"
    consolidation_policy    = "WhenEmptyOrUnderutilized"
    expire_after            = "720h" # 30 days
    ttl_seconds_after_empty = 300    # 5 minutes

    budgets = [
      {
        reasons = ["Underutilized", "Empty"]
        nodes   = "10%"
      }
    ]
  }

  # Resource limits
  limits = {
    cpu    = "1000"
    memory = "1000Gi"
  }

  # AWS-specific configuration
  aws = {
    role             = "KarpenterNodeRole-production"
    instance_profile = "KarpenterNodeInstanceProfile-production"
    ami_family       = "AL2023"

    # AMI selection
    ami_selector_terms = [
      {
        alias = "al2023@latest"
      }
    ]

    # Subnet selection
    subnet_selector_terms = [
      {
        tags = {
          "karpenter.sh/discovery" = "production-cluster"
        }
      }
    ]

    # Security group selection
    security_group_selector_terms = [
      {
        tags = {
          "karpenter.sh/discovery" = "production-cluster"
        }
      }
    ]

    # Instance tags
    tags = {
      "Environment" = "production"
      "ManagedBy"   = "Karpenter"
      "Team"        = "platform"
    }

    # Block device configuration
    block_device_mappings = [
      {
        device_name = "/dev/xvda"
        ebs = {
          volume_size           = "100Gi"
          volume_type           = "gp3"
          encrypted             = true
          delete_on_termination = true
        }
      }
    ]

    # Instance store policy
    instance_store_policy = "RAID0"

    # Monitoring and networking
    detailed_monitoring         = true
    associate_public_ip_address = false

    # IMDS v2 configuration (secure defaults)
    metadata_options = {
      http_endpoint               = "enabled"
      http_protocol_ipv6          = "disabled"
      http_put_response_hop_limit = 2
      http_tokens                 = "required" # Enforces IMDSv2
    }

    # User data for custom initialization
    user_data = <<-EOT
      #!/bin/bash
      echo "Custom initialization script"
      # Add your custom setup here
    EOT
  }
}

# Azure example
resource "devzero_node_policy" "azure_example" {
  name            = "azure-production"
  description     = "Production-ready Azure node policy"
  node_pool_name  = "production-pool"
  node_class_name = "production-class"
  weight          = 10

  # Instance selection
  instance_categories = {
    match_expressions = [{
      key      = "instanceCategories"
      operator = "In"
      values   = ["D", "E"] # General purpose, memory optimized
    }]
  }

  architectures = {
    match_expressions = [{
      key      = "architectures"
      operator = "In"
      values   = ["amd64"]
    }]
  }

  capacity_types = {
    match_expressions = [{
      key      = "capacityTypes"
      operator = "In"
      values   = ["spot", "on-demand"]
    }]
  }

  operating_systems = {
    match_expressions = [{
      key      = "operatingSystems"
      operator = "In"
      values   = ["linux"]
    }]
  }

  # Labels
  labels = {
    "dedicated" = "karpenter"
  }

  # Disruption policy
  disruption = {
    consolidate_after    = "5m"
    consolidation_policy = "WhenEmptyOrUnderutilized"
    expire_after         = "168h" # 7 days

    budgets = [
      {
        reasons = ["Empty", "Drifted", "Underutilized"]
        nodes   = "20%"
      }
    ]
  }

  # Azure-specific configuration
  azure = {
    vnet_subnet_id  = "/subscriptions/xxx/resourceGroups/yyy/providers/Microsoft.Network/virtualNetworks/zzz/subnets/aaa"
    os_disk_size_gb = 128
    image_family    = "Ubuntu2204"
    fips_mode       = "Disabled"
    max_pods        = 110

    tags = {
      "Environment" = "production"
      "ManagedBy"   = "Karpenter"
    }
  }
}
```

<!-- schema generated by tfplugindocs -->
## Schema

### Required

- `name` (String) Human-friendly name for the policy. Used for display in the DevZero UI.

### Optional

- `architectures` (Attributes) CPU architectures selector (e.g., amd64, arm64) (see [below for nested schema](#nestedatt--architectures))
- `architectures_tip` (String) Tooltip for architectures
- `aws` (Attributes) AWS-specific configuration for nodes provisioned with this policy. (see [below for nested schema](#nestedatt--aws))
- `azure` (Attributes) Azure-specific configuration for nodes provisioned with this policy. (see [below for nested schema](#nestedatt--azure))
- `capacity_type_tip` (String) Tooltip for capacity types
- `capacity_types` (Attributes) Capacity types selector (e.g., spot, on-demand, reserved) (see [below for nested schema](#nestedatt--capacity_types))
- `description` (String) Free-form description of the policy to help others understand its intent and scope.
- `disruption` (Attributes) Configuration for node disruption policies including consolidation and expiration settings. (see [below for nested schema](#nestedatt--disruption))
- `disruptions_tip` (String) Tooltip for disruptions
- `instance_categories` (Attributes) Instance categories selector (e.g., D for Azure, m for AWS) (see [below for nested schema](#nestedatt--instance_categories))
- `instance_categories_tip` (String) Tooltip for instance categories
- `instance_cpus` (Attributes) Instance CPU count selector (e.g., 4, 8, 16) (see [below for nested schema](#nestedatt--instance_cpus))
- `instance_cpus_tip` (String) Tooltip for instance CPUs
- `instance_families` (Attributes) Instance families selector (e.g., c5, m5d, r4) (see [below for nested schema](#nestedatt--instance_families))
- `instance_families_tip` (String) Tooltip for instance families
- `instance_generations` (Attributes) Instance generations selector (e.g., 4 for Azure, 5 for AWS) (see [below for nested schema](#nestedatt--instance_generations))
- `instance_generations_tip` (String) Tooltip for instance generations
- `instance_hypervisors` (Attributes) Instance hypervisors selector (see [below for nested schema](#nestedatt--instance_hypervisors))
- `instance_hypervisors_tip` (String) Tooltip for instance hypervisors
- `instance_sizes` (Attributes) Instance sizes selector (e.g., Standard_D4s for Azure, large for AWS) (see [below for nested schema](#nestedatt--instance_sizes))
- `instance_sizes_tip` (String) Tooltip for instance sizes
- `labels` (Map of String) Map of Kubernetes labels to apply to nodes provisioned with this policy.
- `limits` (Attributes) Maximum resource limits for nodes provisioned with this policy. (see [below for nested schema](#nestedatt--limits))
- `limits_tip` (String) Tooltip for limits
- `master_override_role_name` (String) Master override role name for Karpenter
- `node_class_name` (String) Node class name
- `node_pool_name` (String) Node pool name
- `operating_systems` (Attributes) Operating systems selector (e.g., linux, windows) (see [below for nested schema](#nestedatt--operating_systems))
- `operating_systems_tip` (String) Tooltip for operating systems
- `raw` (Attributes List) Raw Karpenter NodePool and NodeClass YAML specifications for advanced use cases. (see [below for nested schema](#nestedatt--raw))
- `taints` (Attributes List) List of Kubernetes taints to apply to nodes provisioned with this policy. (see [below for nested schema](#nestedatt--taints))
- `taints_tip` (String) Tooltip for taints
- `weight` (Number) Priority weight for this node policy. Higher weights are preferred when multiple policies match. Default: 10 (medium priority).
- `zones` (Attributes) Availability zones selector (see [below for nested schema](#nestedatt--zones))
- `zones_tip` (String) Tooltip for zones

### Read-Only

- `id` (String) Unique identifier of the node policy. Managed by the provider.

<a id="nestedatt--architectures"></a>
### Nested Schema for `architectures`

Optional:

- `match_expressions` (Attributes List) List of label selector requirements (see [below for nested schema](#nestedatt--architectures--match_expressions))
- `match_labels` (Map of String) Map of label key-value pairs to match

<a id="nestedatt--architectures--match_expressions"></a>
### Nested Schema for `architectures.match_expressions`

Required:

- `key` (String) Label key
- `operator` (String) Operator for matching. Valid values: `In`, `NotIn`, `Exists`, `DoesNotExist`.

Optional:

- `values` (List of String) List of values for In/NotIn operators



<a id="nestedatt--aws"></a>
### Nested Schema for `aws`

Optional:

- `ami_family` (String) AMI family (e.g., AL2, Bottlerocket, Ubuntu)
- `ami_selector_terms` (Attributes List) AMI selector terms (see [below for nested schema](#nestedatt--aws--ami_selector_terms))
- `associate_public_ip_address` (Boolean) Associate public IP address with instances
- `block_device_mappings` (Attributes List) Block device mappings (see [below for nested schema](#nestedatt--aws--block_device_mappings))
- `detailed_monitoring` (Boolean) Enable detailed CloudWatch monitoring
- `instance_profile` (String) IAM instance profile
- `instance_store_policy` (String) Policy for instance store volumes. Valid value: `RAID0`.
- `metadata_options` (Attributes) Configuration for EC2 instance metadata service. Defaults provide secure IMDS v2 configuration. (see [below for nested schema](#nestedatt--aws--metadata_options))
- `role` (String) IAM role name
- `security_group_selector_terms` (Attributes List) Security group selector terms (see [below for nested schema](#nestedatt--aws--security_group_selector_terms))
- `subnet_selector_terms` (Attributes List) Subnet selector terms (see [below for nested schema](#nestedatt--aws--subnet_selector_terms))
- `tags` (Map of String) AWS tags to apply to instances
- `user_data` (String) User data script for instance initialization

<a id="nestedatt--aws--ami_selector_terms"></a>
### Nested Schema for `aws.ami_selector_terms`

Optional:

- `alias` (String) AMI alias
- `id` (String) AMI ID
- `name` (String) AMI name
- `owner` (String) AMI owner
- `tags` (Map of String) AMI tags selector


<a id="nestedatt--aws--block_device_mappings"></a>
### Nested Schema for `aws.block_device_mappings`

Optional:

- `device_name` (String) Device name (e.g., /dev/xvda)
- `ebs` (Attributes) EBS volume configuration (see [below for nested schema](#nestedatt--aws--block_device_mappings--ebs))

<a id="nestedatt--aws--block_device_mappings--ebs"></a>
### Nested Schema for `aws.block_device_mappings.ebs`

Optional:

- `delete_on_termination` (Boolean) Delete volume on instance termination
- `encrypted` (Boolean) Encrypt the volume
- `iops` (Number) IOPS for io1/io2 volumes
- `kms_key_id` (String) KMS key ID for encryption
- `snapshot_id` (String) Snapshot ID to create volume from
- `throughput` (Number) Throughput in MiB/s for gp3 volumes
- `volume_size` (String) Volume size (e.g., '100Gi')
- `volume_type` (String) Volume type (gp2, gp3, io1, io2, sc1, st1)



<a id="nestedatt--aws--metadata_options"></a>
### Nested Schema for `aws.metadata_options`

Optional:

- `http_endpoint` (String) Enable or disable the HTTP metadata endpoint. Valid values: `enabled`, `disabled`. Default: `enabled`.
- `http_protocol_ipv6` (String) Enable or disable the IPv6 endpoint for the instance metadata service. Valid values: `enabled`, `disabled`. Default: `disabled`.
- `http_put_response_hop_limit` (Number) The desired HTTP PUT response hop limit for instance metadata requests. Default: 2 (secure for containers).
- `http_tokens` (String) Whether the metadata service requires session tokens (IMDSv2). Valid values: `required`, `optional`. Default: `required` (enforces IMDSv2 for security).


<a id="nestedatt--aws--security_group_selector_terms"></a>
### Nested Schema for `aws.security_group_selector_terms`

Optional:

- `id` (String) Security group ID
- `name` (String) Security group name
- `tags` (Map of String) Security group tags selector


<a id="nestedatt--aws--subnet_selector_terms"></a>
### Nested Schema for `aws.subnet_selector_terms`

Optional:

- `id` (String) Subnet ID
- `tags` (Map of String) Subnet tags selector



<a id="nestedatt--azure"></a>
### Nested Schema for `azure`

Optional:

- `fips_mode` (String) FIPS 140-2 mode. Valid values: `FIPS`, `Disabled`.
- `image_family` (String) Azure image family. Valid values: `Ubuntu`, `Ubuntu2204`, `Ubuntu2404`, `AzureLinux`.
- `max_pods` (Number) Maximum number of pods per node
- `os_disk_size_gb` (Number) OS disk size in GB
- `tags` (Map of String) Azure tags to apply to resources
- `vnet_subnet_id` (String) VNet subnet ID


<a id="nestedatt--capacity_types"></a>
### Nested Schema for `capacity_types`

Optional:

- `match_expressions` (Attributes List) List of label selector requirements (see [below for nested schema](#nestedatt--capacity_types--match_expressions))
- `match_labels` (Map of String) Map of label key-value pairs to match

<a id="nestedatt--capacity_types--match_expressions"></a>
### Nested Schema for `capacity_types.match_expressions`

Required:

- `key` (String) Label key
- `operator` (String) Operator for matching. Valid values: `In`, `NotIn`, `Exists`, `DoesNotExist`.

Optional:

- `values` (List of String) List of values for In/NotIn operators



<a id="nestedatt--disruption"></a>
### Nested Schema for `disruption`

Optional:

- `budgets` (Attributes List) Disruption budgets (see [below for nested schema](#nestedatt--disruption--budgets))
- `consolidate_after` (String) Duration string (e.g., '5m', '1h') after which nodes can be consolidated. Default: '15m' (balance between cost optimization and stability).
- `consolidation_policy` (String) Consolidation policy. Valid values: `WhenEmpty`, `WhenEmptyOrUnderutilized`. Default: 'WhenEmptyOrUnderutilized' (best for cost optimization).
- `expire_after` (String) Duration string (e.g., '720h') after which nodes expire and are replaced. Default: '720h' (30 days, balances security and stability).
- `termination_grace_period_seconds` (Number) Grace period for node termination
- `ttl_seconds_after_empty` (Number) Seconds to wait before terminating empty nodes

<a id="nestedatt--disruption--budgets"></a>
### Nested Schema for `disruption.budgets`

Optional:

- `duration` (String) Duration string (e.g., '1h30m') for how long this budget applies.
- `nodes` (String) Maximum nodes that can be disrupted, as percentage (e.g., '10%') or absolute number (e.g., '2').
- `reasons` (List of String) List of reasons that trigger this budget. Examples: `Underutilized`, `Empty`.
- `schedule` (String) Cron schedule for when this budget applies



<a id="nestedatt--instance_categories"></a>
### Nested Schema for `instance_categories`

Optional:

- `match_expressions` (Attributes List) List of label selector requirements (see [below for nested schema](#nestedatt--instance_categories--match_expressions))
- `match_labels` (Map of String) Map of label key-value pairs to match

<a id="nestedatt--instance_categories--match_expressions"></a>
### Nested Schema for `instance_categories.match_expressions`

Required:

- `key` (String) Label key
- `operator` (String) Operator for matching. Valid values: `In`, `NotIn`, `Exists`, `DoesNotExist`.

Optional:

- `values` (List of String) List of values for In/NotIn operators



<a id="nestedatt--instance_cpus"></a>
### Nested Schema for `instance_cpus`

Optional:

- `match_expressions` (Attributes List) List of label selector requirements (see [below for nested schema](#nestedatt--instance_cpus--match_expressions))
- `match_labels` (Map of String) Map of label key-value pairs to match

<a id="nestedatt--instance_cpus--match_expressions"></a>
### Nested Schema for `instance_cpus.match_expressions`

Required:

- `key` (String) Label key
- `operator` (String) Operator for matching. Valid values: `In`, `NotIn`, `Exists`, `DoesNotExist`.

Optional:

- `values` (List of String) List of values for In/NotIn operators



<a id="nestedatt--instance_families"></a>
### Nested Schema for `instance_families`

Optional:

- `match_expressions` (Attributes List) List of label selector requirements (see [below for nested schema](#nestedatt--instance_families--match_expressions))
- `match_labels` (Map of String) Map of label key-value pairs to match

<a id="nestedatt--instance_families--match_expressions"></a>
### Nested Schema for `instance_families.match_expressions`

Required:

- `key` (String) Label key
- `operator` (String) Operator for matching. Valid values: `In`, `NotIn`, `Exists`, `DoesNotExist`.

Optional:

- `values` (List of String) List of values for In/NotIn operators



<a id="nestedatt--instance_generations"></a>
### Nested Schema for `instance_generations`

Optional:

- `match_expressions` (Attributes List) List of label selector requirements (see [below for nested schema](#nestedatt--instance_generations--match_expressions))
- `match_labels` (Map of String) Map of label key-value pairs to match

<a id="nestedatt--instance_generations--match_expressions"></a>
### Nested Schema for `instance_generations.match_expressions`

Required:

- `key` (String) Label key
- `operator` (String) Operator for matching. Valid values: `In`, `NotIn`, `Exists`, `DoesNotExist`.

Optional:

- `values` (List of String) List of values for In/NotIn operators



<a id="nestedatt--instance_hypervisors"></a>
### Nested Schema for `instance_hypervisors`

Optional:

- `match_expressions` (Attributes List) List of label selector requirements (see [below for nested schema](#nestedatt--instance_hypervisors--match_expressions))
- `match_labels` (Map of String) Map of label key-value pairs to match

<a id="nestedatt--instance_hypervisors--match_expressions"></a>
### Nested Schema for `instance_hypervisors.match_expressions`

Required:

- `key` (String) Label key
- `operator` (String) Operator for matching. Valid values: `In`, `NotIn`, `Exists`, `DoesNotExist`.

Optional:

- `values` (List of String) List of values for In/NotIn operators



<a id="nestedatt--instance_sizes"></a>
### Nested Schema for `instance_sizes`

Optional:

- `match_expressions` (Attributes List) List of label selector requirements (see [below for nested schema](#nestedatt--instance_sizes--match_expressions))
- `match_labels` (Map of String) Map of label key-value pairs to match

<a id="nestedatt--instance_sizes--match_expressions"></a>
### Nested Schema for `instance_sizes.match_expressions`

Required:

- `key` (String) Label key
- `operator` (String) Operator for matching. Valid values: `In`, `NotIn`, `Exists`, `DoesNotExist`.

Optional:

- `values` (List of String) List of values for In/NotIn operators



<a id="nestedatt--limits"></a>
### Nested Schema for `limits`

Optional:

- `cpu` (String) Maximum CPU limit for nodes (e.g., '100', '1000').
- `memory` (String) Maximum memory limit for nodes (e.g., '512Gi', '1Ti').


<a id="nestedatt--operating_systems"></a>
### Nested Schema for `operating_systems`

Optional:

- `match_expressions` (Attributes List) List of label selector requirements (see [below for nested schema](#nestedatt--operating_systems--match_expressions))
- `match_labels` (Map of String) Map of label key-value pairs to match

<a id="nestedatt--operating_systems--match_expressions"></a>
### Nested Schema for `operating_systems.match_expressions`

Required:

- `key` (String) Label key
- `operator` (String) Operator for matching. Valid values: `In`, `NotIn`, `Exists`, `DoesNotExist`.

Optional:

- `values` (List of String) List of values for In/NotIn operators



<a id="nestedatt--raw"></a>
### Nested Schema for `raw`

Optional:

- `nodeclass_yaml` (String) Raw NodeClass YAML
- `nodepool_yaml` (String) Raw NodePool YAML


<a id="nestedatt--taints"></a>
### Nested Schema for `taints`

Required:

- `effect` (String) Taint effect. Valid values: `NoSchedule`, `PreferNoSchedule`, `NoExecute`.
- `key` (String) Taint key
- `value` (String) Taint value


<a id="nestedatt--zones"></a>
### Nested Schema for `zones`

Optional:

- `match_expressions` (Attributes List) List of label selector requirements (see [below for nested schema](#nestedatt--zones--match_expressions))
- `match_labels` (Map of String) Map of label key-value pairs to match

<a id="nestedatt--zones--match_expressions"></a>
### Nested Schema for `zones.match_expressions`

Required:

- `key` (String) Label key
- `operator` (String) Operator for matching. Valid values: `In`, `NotIn`, `Exists`, `DoesNotExist`.

Optional:

- `values` (List of String) List of values for In/NotIn operators

## Import

Import is supported using the following syntax:

The [`terraform import` command](https://developer.hashicorp.com/terraform/cli/commands/import) can be used, for example:

```shell
#!/bin/bash

# Import an existing node policy by its ID
terraform import devzero_node_policy.example "policy-id-here"

# Example with actual ID format
terraform import devzero_node_policy.aws_basic "257a5739-b716-42c7-9bc4-1823277f3e5f"
```
